name: Deploy to VPS (gestao-igreja)

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy over SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: Administrator
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22
          debug: true
          request_pty: false
          # IMPORTANTE: desligar o guard que estÃ¡ causando "if ["
          script_stop: false
          command_timeout: 60m
          script: |
  powershell -NoProfile -ExecutionPolicy Bypass -Command "& {
    $ErrorActionPreference = 'Stop'
    function Run($label, [scriptblock]$cmd) {
      Write-Output \"==> $label\"
      & $cmd
      if ($LASTEXITCODE -ne 0) { throw \"$label failed (exit $LASTEXITCODE)\" }
    }

    try {
      Write-Output '=== START DEPLOY ==='
      Set-Location 'C:\apps\gestao-igreja'

      Run 'Pull latest' { git fetch origin; git reset --hard origin/main; git clean -fd }
      Run 'Install deps' { npm install --legacy-peer-deps }
      Run 'Prisma generate' { npx prisma generate }
      Run 'Build' { npm run build }
      Run 'Restart PM2' { pm2 startOrReload ecosystem.config.cjs --update-env; pm2 save; pm2 ls }

      Write-Output '=== DEPLOY END ==='
      exit 0
    }
    catch {
      Write-Output '=== DEPLOY FAILED ==='
      Write-Output $_.Exception.Message
      exit 1
    }
  }"