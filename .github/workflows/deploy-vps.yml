name: Deploy to VPS (gestao-igreja)

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy over SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: Administrator
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22
          debug: true
          request_pty: false
          script: |
            echo "=== START DEPLOY ==="
            powershell -NoProfile -ExecutionPolicy Bypass -Command "& { $log='C:\apps\gestao-igreja\deploy-actions.log'; Remove-Item $log -Force -ErrorAction SilentlyContinue; & 'C:\apps\gestao-igreja\deploy.ps1' *>&1 | Tee-Object -FilePath $log; Get-Content -Path $log -Tail 200 }"
            echo "=== END DEPLOY ==="